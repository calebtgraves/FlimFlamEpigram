<!-- host.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Game Host</title>
    <meta name="viewport" content="width=device-width">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/FlimFlamEpigram.svg') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
    <script type="text/javascript" defer>
        var socket = io();
        
        function requestGameId(){
            socket.emit('game_id_request')
        }

        requestGameId()
        socket.on('game_id', function(data) {
            document.getElementById('game-id').innerText=data.id
        });

        socket.on('instructions',function(data){
            document.getElementById('instructions').style.display = 'block'
        })

        socket.on('new_vip', function(){
            document.getElementById('player-list').removeChild(document.getElementById('player-list').firstChild)
            const newVip = Array.from(document.getElementsByClassName('player-token'))[0]
            newVip.id = "vip-player"
        })

        socket.on('player_disconnected',function(data){
            Array.from(document.getElementsByClassName(`TOKEN-${data}`))[0].remove()
        })

        socket.on('last_player_disconnected', function(){
            document.getElementById('player-list').innerHTML = '';
        })

        socket.on('new_player', function(data) {
            const newPlayer = document.createElement('div');
            const playerName = document.createElement('p')
            playerName.innerText = data.name;
            playerName.style.color=data.color;
            newPlayer.appendChild(playerName);
            newPlayer.classList.add('player-token');
            newPlayer.classList.add(`TOKEN-${data.name}`);
            if(data.vip){
                newPlayer.id = "vip-player"
            }
            newPlayer.style.backgroundColor=data.color
            document.getElementById('player-list').appendChild(newPlayer);
            var vip = data.vip
        });

        function sleep(s) {
            ms = s * 1000
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        socket.on('instructions',function(data){
            let wait = data.wait;
            console.log(`Listening to instructions for ${wait} seconds...`);
            // TODO: Some kind of waiting logic 
            sleep(wait) // wait for a bit
        })


        let players_done
        socket.on('players_done',function(){
            players_done = true
        })

        socket.on('round',function(data){
            if(data.number == 1){
                document.getElementById('host-main-logo').style.display = 'none';
                document.getElementById('code-containter').style.display = 'none';
            }
            Array.from(document.getElementsByClassName('player-token')).forEach((token)=>{
                token.classList.add('grey-out')
            })
            console.log(data.number)
            players_done = false
            let timer = 120
            console.log(timer, players_done)
            const countdown = setInterval(()=>{
                timer -= 1
                console.log(timer)
                if(timer == 0 || players_done){
                    clearInterval(countdown)
                    Array.from(document.getElementsByClassName('player-token')).forEach((token)=>{
                        if(token.classList.contains('grey-out')){
                            token.classList.remove('grey-out')
                        }
                    })
                    socket.emit('answers_done', {'round_num': data.number})
                }
            },1000)
        })

        socket.on('player_answer',function(data){
            Array.from(document.getElementsByClassName(`TOKEN-${data.name}`))[0].classList.remove('grey-out');
        })

        // dictionary[prompt][player_name] = {'answer': answer, 'votes': [player objects]} // dictionary structure for reference

        socket.on('answers',function(data){
            console.log(data);
        })

        // Additional JavaScript for managing game state...
    </script>
</head>
<body>
    <main id="host-main">
        <div id="host-main-logo"></div>
        <div id="code-container">
            <p>Game Code:</p>
            <p id="game-id"></p>
        </div>
        <div id='player-list'></div>
        <div id='instructions' style='display:none'>These are the instructions</div>
    </main>
    <!-- Additional elements for hosting the game -->
</body>
</html>