<!-- host.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Game Host</title>
    <meta name="viewport" content="width=device-width">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/FlimFlamEpigram.svg') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <main id="host-main">
        <div id="host-main-logo"></div>
        <div id="code-container">
            <p>Game Code:</p>
            <p id="game-id"></p>
        </div>
        <div id='player-list'></div>
        <p id="timer"></p>
        <div id="challenge">
            <div id="prompt-container">
            </div>
            <p id="prompt">
            </p>
            <div id="response1">
                <div id="response1-votes" class="response-votes"></div>
                <div id="response1-card" calss="response-card">
                    <p id="response1-text" class="response-text"></p>
                    <div id="response1-author" class="response-answer"></div>
                </div>
            </div>
            <div id="response2">
                <div id="response2-votes" class="response-votes"></div>
                <div id="response2-card" calss="response-card">
                    <p id="response2-text" class="response-text"></p>
                    <div id="response2-author" class="response-answer"></div>
                </div>
            </div>
        </div>
    </main>
    <!-- Additional elements for hosting the game -->
    <script type="text/javascript" defer>
        var socket = io();
        let player_colors = {}
        const timer_element = document.getElementById('timer');
        
        function requestGameId(){
            socket.emit('game_id_request')
        }

        requestGameId()
        socket.on('game_id', function(data) {
            document.getElementById('game-id').innerText=data.id
        });

        socket.on('instructions',function(data){
            document.getElementById('instructions').style.display = 'block'
        })

        socket.on('new_vip', function(){
            document.getElementById('player-list').removeChild(document.getElementById('player-list').firstChild)
            const newVip = Array.from(document.getElementsByClassName('player-token'))[0]
            newVip.id = "vip-player"
        })

        socket.on('player_disconnected',function(data){
            Array.from(document.getElementsByClassName(`TOKEN-${data.split(' ').join('-')}`))[0].remove()
        })

        socket.on('last_player_disconnected', function(){
            document.getElementById('player-list').innerHTML = '';
        })

        socket.on('new_player', function(data) {
            const newPlayer = document.createElement('div');
            const playerName = document.createElement('p')
            playerName.innerText = data.name;
            playerName.style.color=data.color;
            newPlayer.appendChild(playerName);
            newPlayer.classList.add('player-token');

            newPlayer.classList.add(`TOKEN-${data.name.split(' ').join('-')}`);
            if(data.vip){
                newPlayer.id = "vip-player"
            }
            newPlayer.style.backgroundColor=data.color
            document.getElementById('player-list').appendChild(newPlayer);
            var vip = data.vip
        });

        function sleep(s) {
            ms = s * 1000
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        socket.on('instructions',function(data){
            let wait = data.wait;
            console.log(`Listening to instructions for ${wait} seconds...`);
            // TODO: Some kind of waiting logic 
            sleep(wait) // wait for a bit
        })

        socket.on('all_players',function(data){
            for(var player in data){
                player_colors[player['name']] = player['color']
            }
        })

        let players_done
        socket.on('players_done',function(){
            players_done = true
        })

        socket.on('round',function(data){
            document.getElementById('player-list').style.height = "100%";
            if(data.number == 1){
                document.getElementById('host-main-logo').style.display = 'none';
                document.getElementById('code-container').style.display = 'none';
            }
            Array.from(document.getElementsByClassName('player-token')).forEach((token)=>{
                token.classList.add('grey-out')
            })
            console.log(data.number)
            players_done = false
            let timer = 120
            timer_element.style.display = 'block';
            timer_element.innerText = timer
            console.log(timer, players_done)
            const countdown = setInterval(()=>{
                timer -= 1
                timer_element.innerText = timer
                console.log(timer)
                if(timer == 0 || players_done){
                    clearInterval(countdown)
                    Array.from(document.getElementsByClassName('player-token')).forEach((token)=>{
                        if(token.classList.contains('grey-out')){
                            token.classList.remove('grey-out')
                        }
                    })
                    socket.emit('client_input_done')
                    players_done = false
                }
            },1000)
        })

        socket.on('player_answer',function(data){
            Array.from(document.getElementsByClassName(`TOKEN-${data.name.split(' ').join('-')}`))[0].classList.remove('grey-out');
        })

        // dictionary[prompt][player_name] = {'answer': answer, 'crutch': crutch, 'votes': [player objects]} // dictionary structure for reference

        socket.on('answers',function(data){
            //data in this structure: dictionary = {'prompt': {'name': {'answer': answer, 'crutch': crutch, 'votes': [player objects]}}}
            console.log(data);
            document.getElementById('player-list').style.display = 'none';
            document.getElementById('challenge').style.display = 'flex';
            let timer = 20; // ERROR: Counts down by 4, then three, then two, then one
            timer_element.innerText = timer;
            for(var prompt in data){
                document.getElementById('prompt').innerText = prompt
                document.getElementById('prompt-container').innerText = prompt
                let theseResponses = []
                for(var playerName in prompt){
                    theseResponses.push(prompt[playerName])
                }
                document.getElementById('response1-text').innerText = theseResponses[0]
                document.getElementById('response2-text').innerText = theseResponses[1]
                socket.emit('votes_needed', {'prompt': prompt}) // Once competing responses are displayed, start timer and ask for player votes
                const countdown = setInterval(()=>{
                    timer -= 1;
                    timer_element.innerText = timer;
                    if(timer == 0 || players_done){
                        clearInterval(countdown)
                        timer = 5
                        const showVotesCountdown = setInterval(()=>{
                            timer -= 1;
                            timer_element.innerText = timer
                            if(timer == 0){
                                clearInterval(showVotesCountdown)
                                timer = 20
                                players_done = false
                            }
                        },1000)
                    }
                },1000)
            }
        })

        // Additional JavaScript for managing game state...
    </script>
</body>
</html>